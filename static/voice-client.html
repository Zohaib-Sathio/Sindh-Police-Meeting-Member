<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Sindh Police AI Meeting Member - Secretary Dashboard</title>

  <!-- Meta Information -->
  <meta name="description"
    content="Sindh Police AI Meeting Member - AI meeting participation system for Sindh Police Department meetings" />
  <meta name="author" content="Sindh Police" />
  <meta name="robots" content="noindex, nofollow" />

  <!-- Favicon -->
  <link rel="icon" href="/client/logo-with-title.png" type="image/png" />
  <link rel="shortcut icon" href="/client/logo-with-title.png" type="image/png" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />

  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LiveKit Web SDK for HeyGen video streaming -->
  <script src="https://unpkg.com/livekit-client@latest/dist/livekit-client.umd.js"></script>
  <!-- Marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Note: HeyGen SDK requires npm installation and bundling
    // We'll use LiveKit directly for video streaming instead
    console.log('ðŸ“¦ LiveKit SDK loaded for video streaming');
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Premium Dark Navy & Gold Theme
            "navy": {
              50: "#e8eef5",
              100: "#c5d4e8",
              200: "#9fb8d9",
              300: "#7a9cc9",
              400: "#5d84bc",
              500: "#1e3a5f",
              600: "#0f2847",
              700: "#0a1628",
              800: "#060d19",
              900: "#030810",
            },
            "gold": {
              50: "#fef9e6",
              100: "#fdf0bf",
              200: "#fce794",
              300: "#fad969",
              400: "#f8cb47",
              500: "#d4af37",
              600: "#c4a000",
              700: "#a08200",
              800: "#7c6500",
              900: "#584800",
            },
            // Primary colors
            "primary": "#d4af37",
            "primary-dark": "#c4a000",
            "primary-light": "#fad969",
            "secondary": "#1e3a5f",
            "accent": "#d4af37",
            "success": "#10b981",
            "danger": "#ef4444",
            "warning": "#f59e0b",
            "info": "#3b82f6",
            // Legacy names for compatibility
            "pvara-green": "#10b981",
            "pvara-teal": "#1e3a5f",
            "pvara-mint": "#10b981",
            "pvara-gold": "#d4af37",
            "pvara-yellow": "#fad969",
            "pvara-dark": "#0f2847",
            "pvara-darker": "#0a1628",
            // Vote colors
            "vote-for": "#10b981",
            "vote-against": "#ef4444",
            "vote-abstain": "#d4af37",
          },
          fontFamily: {
            sans: ["Inter", "Plus Jakarta Sans", "sans-serif"],
            mono: ["JetBrains Mono", "monospace"],
          },
          backgroundImage: {
            'navy-gradient': 'linear-gradient(135deg, #0a1628 0%, #1e3a5f 50%, #0f2847 100%)',
            'gold-gradient': 'linear-gradient(135deg, #d4af37 0%, #fad969 50%, #c4a000 100%)',
            'navy-radial': 'radial-gradient(ellipse at top, #1e3a5f 0%, #0a1628 100%)',
          },
          animation: {
            "pulse-slow": "pulse 2.5s ease-in-out infinite",
            "fade-in": "fadeIn 0.5s ease-out",
            "slide-up": "slideUp 0.4s ease-out",
            "gradient-shift": "gradientShift 8s ease infinite",
            "shimmer": "shimmer 2s linear infinite",
            "glow": "glow 2s ease-in-out infinite",
          },
          keyframes: {
            fadeIn: {
              "0%": { opacity: "0" },
              "100%": { opacity: "1" },
            },
            slideUp: {
              "0%": { opacity: "0", transform: "translateY(20px)" },
              "100%": { opacity: "1", transform: "translateY(0)" },
            },
            gradientShift: {
              "0%, 100%": { backgroundPosition: "0% 50%" },
              "50%": { backgroundPosition: "100% 50%" },
            },
            shimmer: {
              "0%": { backgroundPosition: "-200% 0" },
              "100%": { backgroundPosition: "200% 0" },
            },
            glow: {
              "0%, 100%": { boxShadow: "0 0 20px rgba(212, 175, 55, 0.3)" },
              "50%": { boxShadow: "0 0 40px rgba(212, 175, 55, 0.6)" },
            },
          },
          boxShadow: {
            'glass': '0 8px 32px rgba(0, 0, 0, 0.3)',
            'gold': '0 4px 20px rgba(212, 175, 55, 0.25)',
            'navy': '0 4px 20px rgba(10, 22, 40, 0.5)',
          },
        },
      },
    };
  </script>
  <style>
    /* Premium Dark Navy & Gold Theme */
    body {
      font-family: "Inter", "Plus Jakarta Sans", sans-serif;
      background: linear-gradient(135deg, #0a1628 0%, #0f2847 50%, #0a1628 100%);
      min-height: 100vh;
      color: #e8eef5;
    }

    /* Subtle animated background pattern */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(30, 58, 95, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(15, 40, 71, 0.4) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
      pointer-events: none;
      z-index: -1;
    }

    /* Glassmorphism Cards */
    .glass-card {
      background: linear-gradient(135deg, rgba(15, 40, 71, 0.8) 0%, rgba(30, 58, 95, 0.6) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(212, 175, 55, 0.15);
      box-shadow:
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
    }

    .glass-card-light {
      background: linear-gradient(135deg, rgba(30, 58, 95, 0.5) 0%, rgba(15, 40, 71, 0.4) 100%);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(212, 175, 55, 0.1);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    /* Status Indicators */
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-online {
      background: #10b981;
      box-shadow: 0 0 12px #10b981, 0 0 24px rgba(16, 185, 129, 0.5);
    }

    .status-unstable {
      background: #d4af37;
      box-shadow: 0 0 12px #d4af37, 0 0 24px rgba(212, 175, 55, 0.5);
    }

    .status-offline {
      background: #ef4444;
      box-shadow: 0 0 12px #ef4444, 0 0 24px rgba(239, 68, 68, 0.5);
    }

    /* Transcript Container */
    .transcript-container {
      height: 400px;
      max-height: 400px;
      overflow-y: auto;
      background: linear-gradient(180deg, rgba(248, 250, 252, 0.95) 0%, rgba(241, 245, 249, 0.9) 100%);
      border: 1px solid rgba(212, 175, 55, 0.2);
    }

    @media (max-width: 640px) {
      .transcript-container {
        height: 300px;
        max-height: 300px;
      }
    }

    /* Responsive Avatar Container */
    @media (max-width: 475px) {
      #avatarContainer {
        padding: 0.75rem;
      }

      #avatarIcon {
        width: 4rem;
        height: 4rem;
      }
    }

    @media (min-width: 475px) and (max-width: 640px) {
      #avatarContainer {
        padding: 1rem;
      }
    }

    @media (min-width: 640px) and (max-width: 1024px) {
      #avatarContainer {
        padding: 1.25rem;
      }
    }

    @media (min-width: 1024px) {
      #avatarContainer {
        padding: 1.25rem;
      }
    }

    #avatarVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }

    @media (max-width: 475px) {
      #avatarContainer>div:last-child {
        min-height: 180px !important;
      }
    }

    @media (min-width: 475px) and (max-width: 640px) {
      #avatarContainer>div:last-child {
        min-height: 220px !important;
      }
    }

    @media (min-width: 640px) and (max-width: 1024px) {
      #avatarContainer>div:last-child {
        min-height: 280px !important;
      }
    }

    .break-words {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    @media (max-width: 640px) {

      button,
      a {
        min-height: 44px;
      }
    }

    @media (max-width: 375px) {
      .transcript-container {
        height: 250px;
        max-height: 250px;
      }
    }

    /* Premium Scrollbar */
    .transcript-container::-webkit-scrollbar {
      width: 6px;
    }

    .transcript-container::-webkit-scrollbar-track {
      background: rgba(10, 22, 40, 0.5);
      border-radius: 3px;
    }

    .transcript-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #d4af37 0%, #c4a000 100%);
      border-radius: 3px;
    }

    .transcript-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #fad969 0%, #d4af37 100%);
    }

    @keyframes pulse-ring {
      0% {
        transform: scale(0.8);
        opacity: 1;
      }

      100% {
        transform: scale(1.8);
        opacity: 0;
      }
    }

    .recording-pulse::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: currentColor;
      animation: pulse-ring 1.5s ease-out infinite;
    }

    .vote-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .vote-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(212, 175, 55, 0.2);
    }

    .typing-indicator::after {
      content: '...';
      animation: typing 1s infinite;
    }

    @keyframes typing {

      0%,
      20% {
        content: '.';
      }

      40% {
        content: '..';
      }

      60%,
      100% {
        content: '...';
      }
    }

    /* Gold Gradient Text */
    .gradient-text {
      background: linear-gradient(135deg, #d4af37 0%, #fad969 50%, #c4a000 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }

    /* Primary Button - Gold Theme */
    .btn-primary {
      background: linear-gradient(135deg, #d4af37 0%, #c4a000 100%);
      color: #0a1628;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
      font-weight: 600;
      border: 1px solid rgba(250, 217, 105, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #fad969 0%, #d4af37 100%);
      box-shadow: 0 6px 25px rgba(212, 175, 55, 0.5);
      transform: translateY(-2px);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      box-shadow: none;
      cursor: not-allowed;
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* Secondary Gold Button */
    .btn-gold {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.2) 0%, rgba(196, 160, 0, 0.3) 100%);
      color: #d4af37;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      border: 1px solid rgba(212, 175, 55, 0.4);
    }

    .btn-gold:hover {
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.3) 0%, rgba(196, 160, 0, 0.4) 100%);
      box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
      transform: translateY(-2px);
    }

    .border-gradient {
      border-color: rgba(212, 175, 55, 0.3);
    }

    .logo-glow {
      filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.3));
      transition: filter 0.3s ease;
    }

    .logo-glow:hover {
      filter: drop-shadow(0 0 16px rgba(212, 175, 55, 0.5));
    }

    /* Markdown Rendering Styles */
    .markdown-content {
      font-family: "Inter", "Plus Jakarta Sans", sans-serif;
      line-height: 1.7;
    }

    .markdown-content h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1e3a5f;
      margin: 1.5rem 0 1rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #d4af37;
    }

    .markdown-content h2 {
      font-size: 1.35rem;
      font-weight: 600;
      color: #1e3a5f;
      margin: 1.25rem 0 0.75rem 0;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .markdown-content h3 {
      font-size: 1.15rem;
      font-weight: 600;
      color: #374151;
      margin: 1rem 0 0.5rem 0;
    }

    .markdown-content p {
      margin: 0.75rem 0;
      color: #374151;
    }

    .markdown-content ul,
    .markdown-content ol {
      margin: 0.75rem 0;
      padding-left: 1.5rem;
    }

    .markdown-content li {
      margin: 0.35rem 0;
      color: #374151;
    }

    .markdown-content li::marker {
      color: #d4af37;
    }

    .markdown-content strong {
      font-weight: 600;
      color: #1f2937;
    }

    .markdown-content em {
      font-style: italic;
      color: #4b5563;
    }

    .markdown-content blockquote {
      border-left: 4px solid #d4af37;
      padding-left: 1rem;
      margin: 1rem 0;
      background: #fef9e6;
      padding: 0.75rem 1rem;
      border-radius: 0 0.5rem 0.5rem 0;
      color: #4b5563;
      font-style: italic;
    }

    .markdown-content code {
      background: #f3f4f6;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-family: "JetBrains Mono", monospace;
      font-size: 0.875em;
      color: #1e3a5f;
    }

    .markdown-content pre {
      background: #1e3a5f;
      color: #e8eef5;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 1rem 0;
    }

    .markdown-content pre code {
      background: transparent;
      padding: 0;
      color: inherit;
    }

    .markdown-content hr {
      border: none;
      border-top: 2px solid #d4af37;
      margin: 1.5rem 0;
      opacity: 0.5;
    }

    .markdown-content table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    .markdown-content th,
    .markdown-content td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.75rem;
      text-align: left;
    }

    .markdown-content th {
      background: #f3f4f6;
      font-weight: 600;
      color: #1e3a5f;
    }

    .markdown-content a {
      color: #d4af37;
      text-decoration: underline;
    }

    .markdown-content a:hover {
      color: #c4a000;
    }

    /* Minutes Modal Tabs */
    .minutes-tab {
      color: #9ca3af;
      border-bottom: 2px solid transparent;
      background: transparent;
    }

    .minutes-tab:hover {
      color: #e5e7eb;
      background: rgba(30, 58, 95, 0.3);
    }

    .minutes-tab.active {
      color: #d4af37;
      border-bottom-color: #d4af37;
      background: rgba(212, 175, 55, 0.08);
    }

    /* Dark-themed markdown inside minutes modal */
    .bg-navy-800\/40 .markdown-content,
    .prose-invert.markdown-content {
      color: #e2e8f0;
    }

    .prose-invert.markdown-content h1 {
      color: #fad969;
      border-bottom-color: rgba(212, 175, 55, 0.4);
    }

    .prose-invert.markdown-content h2 {
      color: #d4af37;
      border-bottom-color: rgba(212, 175, 55, 0.2);
    }

    .prose-invert.markdown-content h3 {
      color: #fce794;
    }

    .prose-invert.markdown-content p,
    .prose-invert.markdown-content li {
      color: #cbd5e1;
    }

    .prose-invert.markdown-content li::marker {
      color: #d4af37;
    }

    .prose-invert.markdown-content strong {
      color: #f1f5f9;
    }

    .prose-invert.markdown-content em {
      color: #94a3b8;
    }

    .prose-invert.markdown-content blockquote {
      border-left-color: #d4af37;
      background: rgba(212, 175, 55, 0.08);
      color: #94a3b8;
    }

    .prose-invert.markdown-content code {
      background: rgba(30, 58, 95, 0.6);
      color: #fad969;
    }

    .prose-invert.markdown-content pre {
      background: rgba(6, 13, 25, 0.6);
      color: #e2e8f0;
    }

    .prose-invert.markdown-content hr {
      border-top-color: rgba(212, 175, 55, 0.3);
    }

    .prose-invert.markdown-content th {
      background: rgba(30, 58, 95, 0.5);
      color: #d4af37;
      border-color: rgba(30, 58, 95, 0.4);
    }

    .prose-invert.markdown-content td {
      border-color: rgba(30, 58, 95, 0.3);
      color: #cbd5e1;
    }

    .prose-invert.markdown-content a {
      color: #fad969;
    }

    .prose-invert.markdown-content a:hover {
      color: #fce794;
    }

    /* AI Character Animations */
    @keyframes mouthSpeak {

      0%,
      100% {
        height: 0.5rem;
        border-radius: 0 0 50% 50%;
      }

      50% {
        height: 1rem;
        border-radius: 0 0 60% 60%;
      }
    }

    @keyframes mouthIdle {

      0%,
      100% {
        height: 0.5rem;
        width: 2rem;
      }

      50% {
        height: 0.6rem;
        width: 2.1rem;
      }
    }

    @keyframes eyeBlink {

      0%,
      90%,
      100% {
        height: 0.75rem;
      }

      95% {
        height: 0.1rem;
      }
    }

    #leftEye,
    #rightEye {
      animation: eyeBlink 3s ease-in-out infinite;
    }

    #rightEye {
      animation-delay: 0.1s;
    }

    /* Character glow effect - Gold Theme */
    #avatarIcon>div:first-child {
      box-shadow: 0 0 20px rgba(212, 175, 55, 0.3),
        0 0 40px rgba(212, 175, 55, 0.15);
    }

    /* Speaking state glow - Gold Pulse */
    #avatarContainer.speaking #avatarIcon>div:first-child {
      box-shadow: 0 0 30px rgba(212, 175, 55, 0.6),
        0 0 60px rgba(212, 175, 55, 0.4);
      animation: pulse-glow-gold 1s ease-in-out infinite;
    }

    @keyframes pulse-glow-gold {

      0%,
      100% {
        box-shadow: 0 0 30px rgba(212, 175, 55, 0.6),
          0 0 60px rgba(212, 175, 55, 0.4);
      }

      50% {
        box-shadow: 0 0 50px rgba(212, 175, 55, 0.8),
          0 0 80px rgba(212, 175, 55, 0.6);
      }
    }
  </style>
</head>

<body class="h-full min-h-screen text-gray-100 flex flex-col">
  <!-- Login Modal -->
  <div id="loginModal"
    class="fixed inset-0 bg-black/85 backdrop-blur-md z-[100] flex items-center justify-center p-3 sm:p-4"
    style="display: flex">
    <div
      class="glass-card rounded-xl sm:rounded-2xl shadow-2xl max-w-md w-full p-5 sm:p-6 md:p-8 animate-slide-up border border-gold-500/30 max-h-[95vh] overflow-y-auto">
      <!-- Logo/Header -->
      <div class="text-center mb-6 sm:mb-8">
        <div class="mb-4 sm:mb-6">
          <img src="/client/logo-with-title.png" alt="Sindh Police Logo" class="h-16 sm:h-20 mx-auto logo-glow"
            onerror="this.style.display='none'; document.getElementById('fallbackLogo').style.display='flex';" />
          <div id="fallbackLogo" class="hidden items-center justify-center">
            <h1 class="text-3xl sm:text-4xl font-bold gradient-text">Sindh Police</h1>
          </div>
        </div>
        <h2 class="text-lg sm:text-xl font-semibold text-white mb-1">AI Meeting Member</h2>
        <p class="text-xs sm:text-sm text-gold-400">Ø³Ù†Ø¯Ú¾ Ù¾ÙˆÙ„ÛŒØ³</p>
        <p class="text-[10px] sm:text-xs text-gray-400 mt-2">Sindh Police Department</p>
      </div>

      <!-- Login Form -->
      <form id="loginForm" class="space-y-4 sm:space-y-5">
        <div>
          <label for="username" class="block text-xs sm:text-sm font-medium text-gray-300 mb-2">Username</label>
          <input type="text" id="username" name="username" required autocomplete="username"
            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-navy-700/50 border border-gold-500/20 rounded-lg text-sm sm:text-base text-white placeholder-gray-500 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 outline-none transition-all"
            placeholder="Enter your username" />
        </div>

        <div>
          <label for="password" class="block text-xs sm:text-sm font-medium text-gray-300 mb-2">Password</label>
          <input type="password" id="password" name="password" required autocomplete="current-password"
            class="w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-navy-700/50 border border-gold-500/20 rounded-lg text-sm sm:text-base text-white placeholder-gray-500 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 outline-none transition-all"
            placeholder="Enter your password" />
        </div>

        <div id="loginError"
          class="hidden bg-red-500/20 border border-red-500/50 rounded-lg p-2.5 sm:p-3 text-xs sm:text-sm text-red-300">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="loginErrorMessage" class="break-words">Invalid credentials</span>
          </div>
        </div>

        <button type="submit" id="loginBtn"
          class="w-full btn-primary text-white font-semibold text-sm sm:text-base py-2.5 sm:py-3 px-4 rounded-lg shadow-lg transform hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2">
          <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
          </svg>
          <span>Sign In</span>
        </button>

        <p class="text-center text-[10px] sm:text-xs text-gray-400 mt-3 sm:mt-4">
          Authorized personnel only
        </p>
      </form>
    </div>
  </div>

  <!-- Connection Alert -->
  <div id="connectionAlert"
    class="hidden fixed top-16 sm:top-20 left-1/2 transform -translate-x-1/2 z-50 animate-slide-up w-[90%] sm:w-auto max-w-md">
    <div id="alertContent" class="glass-card px-4 sm:px-6 py-3 rounded-full flex items-center gap-2 sm:gap-3 border-2">
      <div id="alertIcon" class="flex-shrink-0"></div>
      <span id="alertMessage" class="font-medium text-xs sm:text-sm truncate"></span>
    </div>
  </div>

  <!-- Header -->
  <header
    class="bg-navy-700/80 backdrop-blur-xl border-b border-gold-500/20 sticky top-0 z-40 shadow-lg shadow-navy-900/50">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-2 sm:py-3">
      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4">
        <!-- Logo and Title -->
        <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-shrink-0">
          <img src="/client/logo-with-title.png" alt="Sindh Police" class="h-8 sm:h-10 logo-glow flex-shrink-0"
            onerror="this.outerHTML='<span class=\'text-xl sm:text-2xl font-bold gradient-text\'>Sindh Police</span>'" />
          <div class="min-w-0">
            <h1 class="text-base sm:text-lg font-bold gradient-text truncate">AI Meeting Member</h1>
            <p class="text-[10px] sm:text-xs text-gold-400 hidden xs:block">Secretary Dashboard</p>
          </div>
        </div>

        <!-- Right Side Actions -->
        <div class="flex items-center gap-2 sm:gap-3 md:gap-4 w-full sm:w-auto justify-end flex-wrap">
          <!-- AI Status -->
          <div
            class="flex items-center gap-1.5 sm:gap-2 glass-card-light px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg flex-shrink-0">
            <div id="aiStatus" class="status-indicator status-offline"></div>
            <span id="aiStatusText" class="text-xs sm:text-sm text-white whitespace-nowrap">AI Offline</span>
          </div>

          <!-- Meeting History Link -->
          <a href="/meetings"
            class="text-gray-300 hover:text-gold-400 transition-colors p-1.5 sm:p-2 rounded-lg hover:bg-gold-500/10 flex-shrink-0"
            title="Meeting History">
            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
          </a>

          <!-- Voice Recording Vote Link -->
          <a href="/record"
            class="text-gray-300 hover:text-gold-400 transition-colors p-1.5 sm:p-2 rounded-lg hover:bg-gold-500/10 flex-shrink-0"
            title="Voice Recording Vote">
            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
          </a>

          <!-- User Info -->
          <div id="userInfo" class="hidden items-center gap-1.5 sm:gap-2 text-xs sm:text-sm text-white min-w-0">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span id="userFullName" class="truncate max-w-[100px] sm:max-w-none">User</span>
            <span id="userRole"
              class="text-[10px] sm:text-xs bg-gold-500/20 text-gold-400 px-1.5 sm:px-2 py-0.5 rounded-full border border-gold-500/30 whitespace-nowrap flex-shrink-0">Role</span>
          </div>

          <!-- Logout -->
          <button id="logoutBtn"
            class="hidden text-gray-300 hover:text-gold-400 transition-colors p-1.5 sm:p-2 rounded-lg hover:bg-gold-500/10 flex-shrink-0">
            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 overflow-auto">
    <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-5 md:py-6">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-5 md:gap-6">

        <!-- Left Column: Meeting Controls & Voting -->
        <div class="lg:col-span-4 flex flex-col gap-3 sm:gap-4">
          <!-- Meeting Controls -->
          <div class="glass-card rounded-lg sm:rounded-xl p-4 sm:p-5">
            <h2 class="text-base sm:text-lg font-semibold text-white mb-3 sm:mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gold-400 flex-shrink-0" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <span class="truncate">Meeting Controls</span>
            </h2>

            <!-- Meeting Status -->
            <div id="meetingStatus" class="bg-navy-700/50 rounded-lg p-3 sm:p-4 mb-3 sm:mb-4 border border-gold-500/10">
              <div class="flex items-center justify-between mb-2 flex-wrap gap-2">
                <span class="text-xs sm:text-sm text-gray-400 font-medium">Status</span>
                <span id="meetingStatusBadge"
                  class="text-[10px] sm:text-xs px-2 py-1 rounded-full bg-navy-600/50 text-gray-400 border border-gold-500/20 whitespace-nowrap">No
                  Active Meeting</span>
              </div>
              <div id="meetingIdDisplay" class="text-xs sm:text-sm text-gray-400 hidden break-words">
                Meeting ID: <span id="currentMeetingId" class="font-mono text-gold-400 break-all">â€”</span>
              </div>
              <div id="meetingDuration" class="text-xs sm:text-sm text-gray-400 hidden">
                Duration: <span id="durationDisplay" class="font-mono text-gold-400">00:00:00</span>
              </div>
            </div>

            <!-- Meeting Action Buttons -->
            <div class="space-y-2 sm:space-y-3">
              <button id="startMeetingBtn"
                class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-semibold text-sm sm:text-base py-2.5 sm:py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 shadow-lg shadow-green-900/30">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="truncate">Start Meeting</span>
              </button>

              <button id="endMeetingBtn"
                class="hidden w-full bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-semibold text-sm sm:text-base py-2.5 sm:py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 shadow-lg shadow-red-900/30">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
                <span class="truncate">End Meeting</span>
              </button>
            </div>
          </div>


          <!-- AI Vote Result -->
          <div id="voteResultCard"
            class="hidden glass-card rounded-lg sm:rounded-xl p-4 sm:p-5 vote-card border-2 border-transparent">
            <h2 class="text-base sm:text-lg font-semibold text-white mb-3 sm:mb-4 flex items-center gap-2">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
              </svg>
              <span class="truncate">AI Meeting Member Vote</span>
            </h2>

            <!-- Vote Badge -->
            <div class="text-center mb-3 sm:mb-4">
              <span id="voteBadge"
                class="inline-block text-xl sm:text-2xl font-bold px-4 sm:px-6 py-2 rounded-lg break-words"></span>
            </div>

            <!-- Vote Details -->
            <div class="space-y-2 sm:space-y-3 text-xs sm:text-sm">
              <div>
                <span class="text-gray-600 block mb-1">Motion:</span>
                <p id="voteMotion" class="text-white break-words"></p>
              </div>
              <div>
                <span class="text-gray-500 text-xs font-medium block mb-1">Reasoning:</span>
                <p id="voteReasoning" class="text-white break-words"></p>
              </div>
              <div>
                <span class="text-gray-500 text-xs font-medium block mb-1">Policy Reference:</span>
                <p id="voteReference" class="text-white break-words text-sm"></p>
              </div>
              <div id="voteRiskSection">
                <span class="text-gray-500 text-xs font-medium block mb-1">Risk Assessment:</span>
                <p id="voteRisk" class="text-white break-words text-sm"></p>
              </div>
            </div>

            <div
              class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-200 text-[10px] sm:text-xs text-gray-400 break-words">
              <span id="voteTimestamp"></span>
            </div>
          </div>
        </div>

        <!-- Right Column: Transcript & Audio -->
        <div class="lg:col-span-8 flex flex-col gap-3 sm:gap-4">
          <!-- AI Character Avatar Container -->
          <div id="avatarContainer"
            class="glass-card rounded-lg sm:rounded-xl p-2 sm:p-3 md:p-4 lg:p-5 border border-gray-200"
            style="display: none;">
            <div class="flex items-center justify-between mb-2 sm:mb-3 md:mb-4 gap-2 flex-wrap">
              <h2
                class="text-sm sm:text-base md:text-lg font-semibold text-white flex items-center gap-1.5 sm:gap-2 min-w-0">
                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 md:w-5 md:h-5 text-gray-600 flex-shrink-0" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="truncate text-xs sm:text-sm md:text-base">Sindh Police AI Meeting Member</span>
              </h2>
              <div id="avatarStatus"
                class="text-[9px] xs:text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 sm:py-1 rounded-full bg-gray-700/50 text-gray-400 border border-gray-600/30 whitespace-nowrap flex-shrink-0">
                Connecting...
              </div>
            </div>
            <div class="relative bg-gray-50 rounded-lg overflow-hidden border border-gray-200 shadow-sm w-full"
              style="aspect-ratio: 16/9; min-height: 200px; max-height: 600px;">
              <!-- Video stream (when available) -->
              <video id="avatarVideo" autoplay playsinline muted class="w-full h-full object-cover"
                style="display: none;"></video>

              <!-- Animated Character Placeholder -->
              <div id="avatarPlaceholder" class="absolute inset-0 flex items-center justify-center bg-gray-50">
                <!-- Animated background glow -->
                <div
                  class="absolute inset-0 bg-gradient-to-r from-pvara-teal/20 via-pvara-mint/20 to-pvara-gold/20 animate-gradient-shift bg-[length:200%_200%]">
                </div>

                <!-- Character representation -->
                <div class="relative z-10 text-center px-2 sm:px-3 md:px-4 w-full max-w-full">
                  <!-- Animated avatar icon with speaking animation -->
                  <div id="avatarIcon"
                    class="relative w-16 h-16 xs:w-20 xs:h-20 sm:w-24 sm:h-24 md:w-28 md:h-28 lg:w-32 lg:h-32 mx-auto mb-2 sm:mb-3 md:mb-4">
                    <!-- Main character circle -->
                    <div
                      class="absolute inset-0 rounded-full bg-gradient-to-br from-pvara-teal via-pvara-mint to-pvara-gold p-0.5 sm:p-1 animate-pulse-slow">
                      <div
                        class="w-full h-full rounded-full bg-white flex items-center justify-center border-2 border-gray-200">
                        <!-- Face representation -->
                        <div class="relative">
                          <!-- Eyes -->
                          <div class="flex gap-2 sm:gap-3 md:gap-4 justify-center mb-1 sm:mb-1.5 md:mb-2">
                            <div id="leftEye" class="w-2 h-2 xs:w-2.5 xs:h-2.5 sm:w-3 sm:h-3 bg-gray-800 rounded-full">
                            </div>
                            <div id="rightEye" class="w-2 h-2 xs:w-2.5 xs:h-2.5 sm:w-3 sm:h-3 bg-gray-800 rounded-full">
                            </div>
                          </div>
                          <!-- Mouth (animated when speaking) -->
                          <div id="avatarMouth"
                            class="w-6 h-3 xs:w-7 xs:h-3.5 sm:w-8 sm:h-4 mx-auto border-2 border-gray-800 rounded-full border-t-0">
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Speaking indicator rings -->
                    <div id="speakingRings" class="hidden absolute inset-0">
                      <div class="absolute inset-0 rounded-full border-2 border-green-400 animate-ping opacity-75">
                      </div>
                      <div class="absolute inset-0 rounded-full border-2 border-green-400 animate-ping opacity-50"
                        style="animation-delay: 0.5s;"></div>
                      <div class="absolute inset-0 rounded-full border-2 border-green-400 animate-ping opacity-25"
                        style="animation-delay: 1s;"></div>
                    </div>

                    <!-- Status indicator dot -->
                    <div id="speakingIndicator"
                      class="hidden absolute -bottom-0.5 -right-0.5 sm:-bottom-1 sm:-right-1 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 bg-green-500 rounded-full border-2 border-white animate-pulse shadow-lg">
                    </div>
                  </div>

                  <!-- Character name and status -->
                  <p id="avatarPlaceholderText"
                    class="text-xs xs:text-sm sm:text-base text-gray-800 font-semibold mb-1 sm:mb-2">Sindh Police AI</p>
                  <p id="avatarStatusText" class="text-[10px] xs:text-xs sm:text-sm text-gray-700 px-2 break-words">
                    Ready to participate</p>

                  <!-- Listening indicator -->
                  <div id="listeningIndicator"
                    class="hidden mt-2 sm:mt-3 flex items-center justify-center gap-1.5 sm:gap-2 flex-wrap">
                    <div class="flex gap-0.5 sm:gap-1">
                      <div class="w-1 h-3 xs:w-1.5 xs:h-4 bg-green-500 rounded-full animate-pulse"
                        style="animation-delay: 0s;"></div>
                      <div class="w-1 h-4 xs:w-1.5 xs:h-5 sm:h-6 bg-green-500 rounded-full animate-pulse"
                        style="animation-delay: 0.2s;"></div>
                      <div class="w-1 h-3.5 xs:w-1.5 xs:h-4 sm:h-5 bg-green-500 rounded-full animate-pulse"
                        style="animation-delay: 0.4s;"></div>
                      <div class="w-1 h-3 xs:w-1.5 xs:h-4 bg-green-500 rounded-full animate-pulse"
                        style="animation-delay: 0.6s;"></div>
                    </div>
                    <span class="text-[10px] xs:text-xs text-gray-900 font-medium whitespace-nowrap">Listening...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Live Transcript -->
          <div class="glass-card rounded-lg sm:rounded-xl p-4 sm:p-5">
            <div class="flex items-center justify-between mb-3 sm:mb-4 gap-2 flex-wrap">
              <h2 class="text-base sm:text-lg font-semibold text-white flex items-center gap-2 min-w-0">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 text-black flex-shrink-0" fill="none" stroke="currentColor"
                  viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span class="truncate">Live Transcript</span>
              </h2>
              <div id="recordingIndicator" class="hidden flex items-center gap-1.5 sm:gap-2 flex-shrink-0">
                <div class="relative w-2.5 h-2.5 sm:w-3 sm:h-3">
                  <div class="absolute inset-0 bg-red-500 rounded-full recording-pulse"></div>
                  <div class="relative w-2.5 h-2.5 sm:w-3 sm:h-3 bg-red-500 rounded-full"></div>
                </div>
                <span class="text-[10px] sm:text-xs text-red-400 whitespace-nowrap">Recording</span>
              </div>
            </div>

            <!-- Transcript Area - Fixed Height -->
            <div id="transcriptArea"
              class="transcript-container bg-white rounded-lg p-3 sm:p-4 font-mono text-xs sm:text-sm border border-gray-200">
              <div class="text-gray-600 text-center py-6 sm:py-8">
                <svg class="w-10 h-10 sm:w-12 sm:h-12 mx-auto mb-2 sm:mb-3 text-gray-500" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
                <p class="text-xs sm:text-sm text-gray-700 px-2 text-center">Start a meeting to see the live transcript
                </p>
              </div>
            </div>
          </div>

          <!-- Audio Visualizer & Controls -->
          <div class="glass-card rounded-lg sm:rounded-xl p-4 sm:p-5">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4">
              <div class="flex items-center gap-3 sm:gap-4 w-full sm:w-auto min-w-0">
                <!-- Microphone Button -->
                <button id="micButton" disabled
                  class="relative w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 btn-primary disabled:bg-gray-400 disabled:hover:bg-gray-400 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center group disabled:cursor-not-allowed flex-shrink-0">
                  <svg id="micIcon" class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8 text-white" fill="none"
                    stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                  </svg>
                </button>

                <div class="min-w-0 flex-1">
                  <p id="audioStatus" class="text-white font-medium text-sm sm:text-base truncate">Microphone Off</p>
                  <p id="audioHint" class="text-[10px] sm:text-xs text-gray-400 truncate">Start meeting to enable audio
                  </p>
                </div>
              </div>

              <!-- Audio Visualizer -->
              <div
                class="flex items-center gap-0.5 sm:gap-1 h-10 sm:h-12 w-full sm:w-auto justify-center sm:justify-end">
                <div id="audioVisualizer" class="flex items-end gap-0.5 sm:gap-1 h-full">
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 20%; background: #22c55e;"></div>
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 40%; background: #22c55e;"></div>
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 30%; background: #22c55e;"></div>
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 60%; background: #22c55e;"></div>
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 45%; background: #22c55e;"></div>
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 35%; background: #22c55e;"></div>
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 50%; background: #22c55e;"></div>
                  <div class="w-0.5 sm:w-1 rounded-full transition-all duration-100"
                    style="height: 25%; background: #22c55e;"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Guide -->
          <div class="glass-card rounded-lg sm:rounded-xl p-4 sm:p-5">
            <h2 class="text-base sm:text-lg font-semibold text-white mb-3 flex items-center gap-2">
              <svg class="w-4 h-4 sm:w-5 sm:h-5 text-gold-400 flex-shrink-0" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="truncate">Quick Guide</span>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 text-xs sm:text-sm">
              <div class="bg-navy-700/60 rounded-lg p-2.5 sm:p-3 border border-gold-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span
                    class="w-5 h-5 sm:w-6 sm:h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-[10px] sm:text-xs font-bold border border-green-300 flex-shrink-0">1</span>
                  <span class="font-medium text-white text-sm sm:text-base">Start Meeting</span>
                </div>
                <p class="text-gray-300 text-[10px] sm:text-xs">AI will acknowledge listening on each turn.</p>
              </div>
              <div class="bg-navy-700/60 rounded-lg p-2.5 sm:p-3 border border-gold-500/20">
                <div class="flex items-center gap-2 mb-2">
                  <span
                    class="w-5 h-5 sm:w-6 sm:h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-[10px] sm:text-xs font-bold border border-blue-300 flex-shrink-0">2</span>
                  <span class="font-medium text-white text-sm sm:text-base">Ask for Opinion</span>
                </div>
                <p class="text-gray-300 text-[10px] sm:text-xs">Say "Sindh Police AI, your opinion?" or "Sindh Police
                  AI, apki raye?" to get full analysis.</p>
              </div>
              <div class="bg-navy-700/60 rounded-lg p-2.5 sm:p-3 border border-gold-500/20 sm:col-span-2 lg:col-span-1">
                <div class="flex items-center gap-2 mb-2">
                  <span
                    class="w-5 h-5 sm:w-6 sm:h-6 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-[10px] sm:text-xs font-bold border border-amber-300 flex-shrink-0">3</span>
                  <span class="font-medium text-white text-sm sm:text-base">Request Vote</span>
                </div>
                <p class="text-gray-300 text-[10px] sm:text-xs">Enter motion and click "Mark as Voting Item" for AI
                  vote.</p>
              </div>
            </div>
            <!-- Listen-only mode indicator -->
            <div class="mt-3 sm:mt-4 p-2.5 sm:p-3 bg-navy-700/60 rounded-lg border border-gold-500/20">
              <p class="text-[10px] sm:text-xs text-gray-300 flex items-start gap-2">
                <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600 flex-shrink-0 mt-0.5" fill="none"
                  stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
                <span class="break-words"><strong>Listen Mode:</strong> AI's unique name is <strong>"Sindh Police
                    AI"</strong>. It says "Listening silently" (English) or "Sun rahi hun" (Urdu) on each turn. Only
                  provides full opinion when addressed by name: "Sindh Police AI, your opinion?"</span>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ==========================================================================
    // Sindh Police AI Meeting Member - Secretary Dashboard JavaScript
    // ==========================================================================

    // State
    let authToken = null;
    let currentUser = null;
    let meetingActive = false;
    let currentMeetingId = null;
    let meetingStartTime = null;
    let durationInterval = null;

    // Audio state
    let audioContext = null;
    let mediaStream = null;
    let websocket = null;
    let audioWorkletNode = null;
    let isRecording = false;

    // Transcript buffering - to merge word-by-word into complete messages
    let transcriptBuffer = {
      currentSpeaker: null,
      currentText: '',
      currentElement: null,
      lastUpdateTime: null,
      flushTimeout: null
    };
    const TRANSCRIPT_FLUSH_DELAY = 1500;

    // HeyGen Avatar state
    let heygenAvatar = null;
    let heygenSessionId = null;
    let heygenSessionActive = false;
    let aiResponseTextBuffer = ''; // Buffer to accumulate AI response text

    // DOM Elements
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const loginErrorMessage = document.getElementById('loginErrorMessage');
    const userInfo = document.getElementById('userInfo');
    const userFullName = document.getElementById('userFullName');
    const userRole = document.getElementById('userRole');
    const logoutBtn = document.getElementById('logoutBtn');

    const aiStatus = document.getElementById('aiStatus');
    const aiStatusText = document.getElementById('aiStatusText');
    const connectionAlert = document.getElementById('connectionAlert');

    const startMeetingBtn = document.getElementById('startMeetingBtn');
    const endMeetingBtn = document.getElementById('endMeetingBtn');

    // HeyGen Avatar DOM elements
    const avatarContainer = document.getElementById('avatarContainer');
    const avatarVideo = document.getElementById('avatarVideo');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const avatarStatus = document.getElementById('avatarStatus');
    const avatarPlaceholderText = document.getElementById('avatarPlaceholderText');
    const avatarStatusText = document.getElementById('avatarStatusText');
    const speakingIndicator = document.getElementById('speakingIndicator');
    const meetingStatusBadge = document.getElementById('meetingStatusBadge');
    const meetingIdDisplay = document.getElementById('meetingIdDisplay');
    const currentMeetingIdSpan = document.getElementById('currentMeetingId');
    const meetingDuration = document.getElementById('meetingDuration');
    const durationDisplay = document.getElementById('durationDisplay');


    const voteResultCard = document.getElementById('voteResultCard');
    const voteBadge = document.getElementById('voteBadge');
    const voteMotion = document.getElementById('voteMotion');
    const voteReasoning = document.getElementById('voteReasoning');
    const voteReference = document.getElementById('voteReference');
    const voteRisk = document.getElementById('voteRisk');
    const voteTimestamp = document.getElementById('voteTimestamp');

    const transcriptArea = document.getElementById('transcriptArea');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const micButton = document.getElementById('micButton');
    const audioStatus = document.getElementById('audioStatus');
    const audioHint = document.getElementById('audioHint');
    const audioVisualizer = document.getElementById('audioVisualizer');

    // ==========================================================================
    // Authentication
    // ==========================================================================

    function checkSession() {
      const token = localStorage.getItem('pvara_token');
      const user = localStorage.getItem('pvara_user');

      if (token && user) {
        authToken = token;
        currentUser = JSON.parse(user);
        showDashboard();
      }
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          authToken = data.token;
          currentUser = data.user;

          localStorage.setItem('pvara_token', authToken);
          localStorage.setItem('pvara_user', JSON.stringify(currentUser));

          showDashboard();
        } else {
          showLoginError(data.detail || 'Invalid credentials');
        }
      } catch (error) {
        showLoginError('Connection error. Please try again.');
      }
    });

    function showLoginError(message) {
      loginError.classList.remove('hidden');
      loginErrorMessage.textContent = message;
    }

    function showDashboard() {
      loginModal.style.display = 'none';
      userInfo.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');
      userFullName.textContent = currentUser.full_name;
      userRole.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);

      // Admin link removed

      updateAIStatus('ready');
    }

    logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('pvara_token');
      localStorage.removeItem('pvara_user');
      authToken = null;
      currentUser = null;
      location.reload();
    });

    // ==========================================================================
    // Meeting Management
    // ==========================================================================

    startMeetingBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/meeting/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({})
        });

        const data = await response.json();

        if (response.ok && data.success) {
          meetingActive = true;
          currentMeetingId = data.message.split(' ')[2];
          meetingStartTime = new Date();

          updateMeetingUI(true);
          startAudioSession();
          startDurationTimer();
          startHeyGenAvatar(); // Initialize HeyGen avatar

          showConnectionAlert('success', 'Meeting started successfully');
        } else {
          showConnectionAlert('error', data.detail || 'Failed to start meeting');
        }
      } catch (error) {
        showConnectionAlert('error', 'Connection error');
      }
    });

    endMeetingBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to end this meeting?')) return;

      try {
        // Disable button and show loading state
        endMeetingBtn.disabled = true;
        endMeetingBtn.innerHTML = `
            <svg class="animate-spin w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="truncate">Ending Meeting...</span>
          `;

        flushTranscriptBuffer();
        await stopAudioSession();
        await stopHeyGenAvatar(); // Stop HeyGen avatar

        const response = await fetch('/api/meeting/end', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ meeting_id: currentMeetingId })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Store meeting ID before it gets cleared
          const endedMeetingId = currentMeetingId || data.meeting_id;

          meetingActive = false;
          updateMeetingUI(false);
          stopDurationTimer();

          const durationMsg = `Meeting ended. Duration: ${data.duration_minutes} minutes`;

          // Show meeting minutes popup
          if (data.notes_generated && data.meeting_notes) {
            showConnectionAlert('success', durationMsg + ' Meeting minutes are ready!');
            setTimeout(() => {
              displayMeetingMinutes(data, data.meeting_notes, endedMeetingId);
            }, 1000);
          } else if (data.minutes) {
            showConnectionAlert('success', durationMsg);
            setTimeout(() => {
              displayMeetingMinutes(data, null, endedMeetingId);
            }, 1000);
          } else if (data.notes_generated === false) {
            showConnectionAlert('info', durationMsg + ' Please wait, meeting notes are being generated...');
            setTimeout(() => {
              showConnectionAlert('info', 'Meeting notes generation may take a moment. Please refresh to check.');
            }, 3000);
          } else {
            showConnectionAlert('success', durationMsg);
          }
        }
      } catch (error) {
        showConnectionAlert('error', 'Failed to end meeting');
        // Reset button on error
        endMeetingBtn.disabled = false;
        endMeetingBtn.innerHTML = `
            <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
            </svg>
            <span class="truncate">End Meeting</span>
          `;
      }
    });


    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function displayMeetingMinutes(data, notes, meetingId) {
      const minutes = data.minutes || {};
      const transcript = minutes.transcript || [];
      const votes = minutes.votes || [];
      const motions = minutes.motions || [];
      const startTime = minutes.start_time || '';
      const endTime = minutes.end_time || '';
      const agenda = minutes.agenda || '';
      const durationMin = data.duration_minutes || 0;

      const formatTime = (iso) => {
        if (!iso) return 'N/A';
        try {
          const d = new Date(iso);
          return d.toLocaleString('en-PK', { dateStyle: 'medium', timeStyle: 'short' });
        } catch { return iso; }
      };

      const speakersSet = new Set(transcript.map(t => t.speaker).filter(Boolean));
      const speakers = [...speakersSet];

      const voteColorClass = (v) => {
        if (v === 'FOR') return 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30';
        if (v === 'AGAINST') return 'bg-red-500/20 text-red-400 border-red-500/30';
        return 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30';
      };

      // Build transcript HTML
      let transcriptHtml = '';
      if (transcript.length === 0) {
        transcriptHtml = '<p class="text-gray-400 text-sm italic">No transcript entries recorded.</p>';
      } else {
        transcriptHtml = transcript.map(entry => {
          const time = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString('en-PK', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '';
          const isSindh = (entry.speaker || '').toLowerCase().includes('sindh');
          const speakerColor = isSindh ? 'text-gold-400' : 'text-blue-400';
          return `<div class="flex gap-3 py-2 border-b border-navy-600/30 last:border-0">
            <span class="text-xs text-gray-500 font-mono whitespace-nowrap pt-0.5">${escapeHtml(time)}</span>
            <div>
              <span class="text-xs font-semibold ${speakerColor}">${escapeHtml(entry.speaker || 'Unknown')}</span>
              <p class="text-sm text-gray-200 mt-0.5">${escapeHtml(entry.text || '')}</p>
            </div>
          </div>`;
        }).join('');
      }

      // Build votes HTML
      let votesHtml = '';
      if (votes.length === 0) {
        votesHtml = '<p class="text-gray-400 text-sm italic">No votes were cast during this meeting.</p>';
      } else {
        votesHtml = votes.map(v => `
          <div class="bg-navy-700/50 rounded-lg p-4 border border-navy-600/30 space-y-2">
            <div class="flex items-center justify-between">
              <h4 class="text-sm font-semibold text-gray-200 flex-1 mr-3">${escapeHtml(v.motion || 'N/A')}</h4>
              <span class="text-xs font-bold px-3 py-1 rounded-full border ${voteColorClass(v.vote)}">${escapeHtml(v.vote || 'N/A')}</span>
            </div>
            <p class="text-xs text-gray-400"><span class="text-gray-500">Reasoning:</span> ${escapeHtml(v.reasoning || 'N/A')}</p>
            ${v.regulatory_reference ? `<p class="text-xs text-gray-400"><span class="text-gray-500">Reference:</span> ${escapeHtml(v.regulatory_reference)}</p>` : ''}
            ${v.risk_assessment ? `<p class="text-xs text-gray-400"><span class="text-gray-500">Risk:</span> ${escapeHtml(v.risk_assessment)}</p>` : ''}
          </div>
        `).join('');
      }

      // Build motions HTML
      let motionsHtml = '';
      if (motions.length === 0) {
        motionsHtml = '<p class="text-gray-400 text-sm italic">No motions were raised during this meeting.</p>';
      } else {
        motionsHtml = motions.map(m => {
          const statusColor = m.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30' : 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30';
          return `<div class="bg-navy-700/50 rounded-lg p-4 border border-navy-600/30 space-y-1">
            <div class="flex items-center justify-between">
              <p class="text-sm text-gray-200 font-medium">${escapeHtml(m.motion_text || 'N/A')}</p>
              <span class="text-xs px-2 py-0.5 rounded-full border ${statusColor} whitespace-nowrap ml-2">${escapeHtml(m.status || 'unknown')}</span>
            </div>
            <p class="text-xs text-gray-500">Proposed by: ${escapeHtml(m.proposed_by || 'N/A')}</p>
          </div>`;
        }).join('');
      }

      const notesContent = notes;
      const notesMeetingId = meetingId;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-md z-[100] flex items-center justify-center p-4 animate-fade-in';
      modal.innerHTML = `
        <div class="bg-navy-700 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[92vh] flex flex-col border border-gold-500/20 animate-slide-up overflow-hidden">
          <!-- Header -->
          <div class="flex-shrink-0 flex items-center justify-between px-6 py-4 border-b border-navy-600/50 bg-navy-800/50 rounded-t-2xl">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-gold-500/20 flex items-center justify-center">
                <svg class="w-5 h-5 text-gold-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
              </div>
              <div>
                <h2 class="text-lg font-bold text-white">Minutes of the Meeting</h2>
                <p class="text-xs text-gray-400">${escapeHtml(meetingId)}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button id="minutesDownloadBtn" class="text-gray-400 hover:text-gold-400 p-2 rounded-lg hover:bg-navy-600/50 transition-colors" title="Download as DOCX">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              </button>
              <button id="closeMinutesModal" class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-navy-600/50 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Overview Stats -->
          <div class="flex-shrink-0 px-6 py-4 border-b border-navy-600/30 bg-navy-800/30">
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              <div class="bg-navy-700/60 rounded-lg p-3 border border-navy-600/30 text-center">
                <p class="text-xs text-gray-500 uppercase tracking-wide">Started</p>
                <p class="text-sm font-semibold text-gray-200 mt-1">${formatTime(startTime)}</p>
              </div>
              <div class="bg-navy-700/60 rounded-lg p-3 border border-navy-600/30 text-center">
                <p class="text-xs text-gray-500 uppercase tracking-wide">Duration</p>
                <p class="text-sm font-semibold text-gold-400 mt-1">${durationMin} min</p>
              </div>
              <div class="bg-navy-700/60 rounded-lg p-3 border border-navy-600/30 text-center">
                <p class="text-xs text-gray-500 uppercase tracking-wide">Votes Cast</p>
                <p class="text-sm font-semibold text-emerald-400 mt-1">${votes.length}</p>
              </div>
              <div class="bg-navy-700/60 rounded-lg p-3 border border-navy-600/30 text-center">
                <p class="text-xs text-gray-500 uppercase tracking-wide">Motions</p>
                <p class="text-sm font-semibold text-blue-400 mt-1">${motions.length}</p>
              </div>
            </div>
            ${speakers.length > 0 ? `
            <div class="mt-3 flex flex-wrap items-center gap-2">
              <span class="text-xs text-gray-500">Participants:</span>
              ${speakers.map(s => `<span class="text-xs bg-navy-600/60 text-gray-300 px-2 py-0.5 rounded-full border border-navy-500/30">${escapeHtml(s)}</span>`).join('')}
            </div>` : ''}
          </div>

          <!-- Tabs -->
          <div class="flex-shrink-0 px-6 pt-3 border-b border-navy-600/30 flex gap-1 overflow-x-auto" id="minutesTabs">
            <button class="minutes-tab active px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap" data-tab="overview">
              AI Notes
            </button>
            <button class="minutes-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap" data-tab="transcript">
              Transcript <span class="text-xs opacity-60">(${transcript.length})</span>
            </button>
            <button class="minutes-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap" data-tab="votes">
              Votes <span class="text-xs opacity-60">(${votes.length})</span>
            </button>
            <button class="minutes-tab px-4 py-2 text-sm font-medium rounded-t-lg transition-colors whitespace-nowrap" data-tab="motions">
              Motions <span class="text-xs opacity-60">(${motions.length})</span>
            </button>
          </div>

          <!-- Tab Content -->
          <div class="flex-1 min-h-0 overflow-y-auto p-6">
            <!-- AI Notes Tab -->
            <div class="minutes-tab-content" data-tab="overview">
              ${notesContent ? `<div class="markdown-content prose prose-invert prose-sm max-w-none text-gray-200 bg-navy-800/40 rounded-lg p-5 border border-navy-600/30">${marked.parse(notesContent)}</div>` : '<p class="text-gray-400 text-sm italic">Meeting notes were not generated for this session.</p>'}
            </div>
            <!-- Transcript Tab -->
            <div class="minutes-tab-content hidden" data-tab="transcript">
              <div class="space-y-0 bg-navy-800/40 rounded-lg p-4 border border-navy-600/30 max-h-[50vh] overflow-y-auto">
                ${transcriptHtml}
              </div>
            </div>
            <!-- Votes Tab -->
            <div class="minutes-tab-content hidden" data-tab="votes">
              <div class="space-y-3">
                ${votesHtml}
              </div>
            </div>
            <!-- Motions Tab -->
            <div class="minutes-tab-content hidden" data-tab="motions">
              <div class="space-y-3">
                ${motionsHtml}
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Tab switching
      modal.querySelectorAll('.minutes-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          modal.querySelectorAll('.minutes-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const target = tab.dataset.tab;
          modal.querySelectorAll('.minutes-tab-content').forEach(c => {
            c.classList.toggle('hidden', c.dataset.tab !== target);
          });
        });
      });

      // Close modal
      document.getElementById('closeMinutesModal').addEventListener('click', () => {
        document.body.removeChild(modal);
      });

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) document.body.removeChild(modal);
      });

      // Download notes as DOCX
      const downloadBtnElement = document.getElementById('minutesDownloadBtn');
      if (downloadBtnElement) {
        downloadBtnElement.addEventListener('click', async () => {
          try {
            const downloadBtn = document.getElementById('minutesDownloadBtn');
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = `
              <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            `;

            if (!notesContent || !notesContent.trim()) {
              showConnectionAlert('error', 'No notes content available to download');
              return;
            }

            const response = await fetch('/api/meeting/notes/download-docx', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
              },
              body: JSON.stringify({
                meeting_id: notesMeetingId,
                notes: notesContent
              })
            });

            if (response.ok) {
              const blob = await response.blob();
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `meeting-minutes-${notesMeetingId}-${new Date().toISOString().split('T')[0]}.docx`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              showConnectionAlert('success', 'Meeting minutes downloaded as DOCX');
            } else {
              let errorMsg = 'Failed to generate DOCX file';
              try {
                const errorData = await response.json();
                errorMsg = errorData.detail || errorMsg;
              } catch (e) {
                errorMsg = `HTTP ${response.status}: ${response.statusText}`;
              }
              throw new Error(errorMsg);
            }
          } catch (error) {
            console.error('Error downloading minutes:', error);
            showConnectionAlert('error', error.message || 'Failed to download meeting minutes');
          } finally {
            const downloadBtn = document.getElementById('minutesDownloadBtn');
            if (downloadBtn) {
              downloadBtn.disabled = false;
              downloadBtn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
              `;
            }
          }
        });
      }

      // Close on escape key
      const handleEscape = (e) => {
        if (e.key === 'Escape') {
          if (document.body.contains(modal)) document.body.removeChild(modal);
          document.removeEventListener('keydown', handleEscape);
        }
      };
      document.addEventListener('keydown', handleEscape);
    }

    function updateMeetingUI(active) {
      if (active) {
        startMeetingBtn.classList.add('hidden');
        endMeetingBtn.classList.remove('hidden');

        // Reset end button to normal state (in case it was in "Ending Meeting..." state)
        endMeetingBtn.disabled = false;
        endMeetingBtn.innerHTML = `
            <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
            </svg>
            <span class="truncate">End Meeting</span>
          `;

        meetingStatusBadge.textContent = 'Active';
        meetingStatusBadge.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30';
        meetingIdDisplay.classList.remove('hidden');
        currentMeetingIdSpan.textContent = currentMeetingId;
        meetingDuration.classList.remove('hidden');
        micButton.disabled = false;
        recordingIndicator.classList.remove('hidden');

        // Ensure avatar container is visible
        if (avatarContainer) {
          avatarContainer.style.display = 'block';
          avatarContainer.classList.remove('hidden');
        }

        transcriptArea.innerHTML = '';
        addSystemMessage(`Meeting started at ${new Date().toLocaleTimeString()}`);
      } else {
        startMeetingBtn.classList.remove('hidden');
        endMeetingBtn.classList.add('hidden');

        // Reset end button to normal state when meeting ends
        endMeetingBtn.disabled = false;
        endMeetingBtn.innerHTML = `
            <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
            </svg>
            <span class="truncate">End Meeting</span>
          `;

        meetingStatusBadge.textContent = 'No Active Meeting';
        meetingStatusBadge.className = 'text-xs px-2 py-1 rounded-full bg-gray-700/50 text-gray-400 border border-gray-600/30';
        meetingIdDisplay.classList.add('hidden');
        meetingDuration.classList.add('hidden');
        micButton.disabled = true;
        recordingIndicator.classList.add('hidden');
        currentMeetingId = null;

        // Hide avatar when meeting ends
        if (avatarContainer) {
          avatarContainer.style.display = 'none';
          avatarContainer.classList.add('hidden');
        }
      }
    }

    function startDurationTimer() {
      durationInterval = setInterval(() => {
        if (meetingStartTime) {
          const elapsed = Math.floor((new Date() - meetingStartTime) / 1000);
          const hours = Math.floor(elapsed / 3600).toString().padStart(2, '0');
          const minutes = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
          const seconds = (elapsed % 60).toString().padStart(2, '0');
          durationDisplay.textContent = `${hours}:${minutes}:${seconds}`;
        }
      }, 1000);
    }

    function stopDurationTimer() {
      if (durationInterval) {
        clearInterval(durationInterval);
        durationInterval = null;
      }
    }


    function displayVoteResult(voteData) {
      console.log('ðŸ“Š Displaying vote result:', voteData);

      voteResultCard.classList.remove('hidden');

      // Extract vote data - handle different data structures
      const vote = voteData.vote || voteData.vote_record?.vote || '';
      const record = voteData.vote_record || voteData;

      // Extract all possible field names
      const motion = record.motion || record.motion_description || record.motion_text || '';
      const reasoning = record.reasoning || '';
      const regulatoryRef = record.regulatory_reference || record.regulatory_reference || '';
      const riskAssessment = record.risk_assessment || '';

      console.log('ðŸ“Š Extracted vote data:', {
        vote,
        motion,
        reasoning: reasoning.substring(0, 50) + '...',
        regulatoryRef: regulatoryRef.substring(0, 50) + '...',
        riskAssessment: riskAssessment.substring(0, 50) + '...'
      });

      let bgClass, textClass, borderClass;
      if (vote === 'FOR') {
        bgClass = 'bg-vote-for/20';
        textClass = 'text-vote-for';
        borderClass = 'border-vote-for';
      } else if (vote === 'AGAINST') {
        bgClass = 'bg-vote-against/20';
        textClass = 'text-vote-against';
        borderClass = 'border-vote-against';
      } else {
        bgClass = 'bg-vote-abstain/20';
        textClass = 'text-vote-abstain';
        borderClass = 'border-vote-abstain';
      }

      voteBadge.textContent = vote || 'ABSTAIN';
      voteBadge.className = `inline-block text-2xl font-bold px-6 py-2 rounded-lg ${bgClass} ${textClass}`;
      voteResultCard.className = `glass-card rounded-xl p-5 vote-card border-2 ${borderClass}`;

      // Set vote details - ensure we show something even if empty
      voteMotion.textContent = motion || 'No motion description provided';
      voteReasoning.textContent = reasoning || 'No reasoning provided';
      voteReference.textContent = regulatoryRef || 'No regulatory reference provided';

      if (riskAssessment && riskAssessment.trim()) {
        document.getElementById('voteRiskSection').classList.remove('hidden');
        voteRisk.textContent = riskAssessment;
      } else {
        document.getElementById('voteRiskSection').classList.add('hidden');
      }

      // Format timestamp
      const timestamp = record.timestamp ? new Date(record.timestamp).toLocaleString() : new Date().toLocaleString();
      voteTimestamp.textContent = `Voted at ${timestamp}`;

      flushTranscriptBuffer();
      addCompleteTranscriptEntry('Sindh Police AI', `ðŸ—³ï¸ VOTE: ${vote || 'ABSTAIN'} â€” ${reasoning || 'No reasoning provided'}`);
    }

    // ==========================================================================
    // Audio & WebSocket
    // ==========================================================================

    async function startAudioSession() {
      try {
        const response = await fetch('/start-browser-call', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ meeting_id: currentMeetingId })
        });

        const data = await response.json();
        const callId = data.call_id;

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        websocket = new WebSocket(`${protocol}//${window.location.host}/media-stream-browser`);

        websocket.onopen = () => {
          console.log('WebSocket connected');
          updateAIStatus('online');

          websocket.send(JSON.stringify({
            event: 'start',
            start: {
              streamSid: 'browser-stream',
              customParameters: {
                token: authToken,
                call_id: callId,
                meeting_id: currentMeetingId
              }
            }
          }));

          startAudioCapture();
        };

        websocket.onmessage = handleWebSocketMessage;

        websocket.onclose = () => {
          console.log('WebSocket closed');
          updateAIStatus('offline');
          stopAudioCapture();
        };

        websocket.onerror = (error) => {
          console.error('WebSocket error:', error);
          updateAIStatus('unstable');
          showConnectionAlert('error', 'Connection error');
        };

      } catch (error) {
        console.error('Failed to start audio session:', error);
        showConnectionAlert('error', 'Failed to connect to AI');
      }
    }

    async function stopAudioSession() {
      stopAudioCapture();

      if (websocket) {
        websocket.send(JSON.stringify({ event: 'stop' }));
        websocket.close();
        websocket = null;
      }

      updateAIStatus('ready');
    }

    async function startAudioCapture() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new AudioContext({ sampleRate: 8000 });

        await audioContext.audioWorklet.addModule('data:text/javascript,' + encodeURIComponent(`
            class AudioProcessor extends AudioWorkletProcessor {
              process(inputs) {
                const input = inputs[0];
                if (input.length > 0) {
                  const samples = input[0];
                  const int16 = new Int16Array(samples.length);
                  for (let i = 0; i < samples.length; i++) {
                    int16[i] = Math.max(-32768, Math.min(32767, samples[i] * 32768));
                  }
                  this.port.postMessage(int16.buffer);
                }
                return true;
              }
            }
            registerProcessor('audio-processor', AudioProcessor);
          `));

        const source = audioContext.createMediaStreamSource(mediaStream);
        audioWorkletNode = new AudioWorkletNode(audioContext, 'audio-processor');

        audioWorkletNode.port.onmessage = (event) => {
          if (websocket && websocket.readyState === WebSocket.OPEN) {
            const base64 = arrayBufferToBase64(event.data);
            websocket.send(JSON.stringify({
              event: 'media',
              media: { payload: base64 }
            }));
          }
        };

        source.connect(audioWorkletNode);
        audioWorkletNode.connect(audioContext.destination);

        isRecording = true;
        audioStatus.textContent = 'Listening...';
        audioHint.textContent = 'AI is listening to the meeting';
        startAudioVisualization();

      } catch (error) {
        console.error('Failed to start audio capture:', error);
        showConnectionAlert('error', 'Microphone access denied');
      }
    }

    function stopAudioCapture() {
      isRecording = false;

      if (audioWorkletNode) {
        audioWorkletNode.disconnect();
        audioWorkletNode = null;
      }

      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }

      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }

      audioStatus.textContent = 'Microphone Off';
      audioHint.textContent = 'Start meeting to enable audio';
      stopAudioVisualization();
    }

    function handleWebSocketMessage(event) {
      const data = JSON.parse(event.data);

      switch (data.event) {
        case 'media':
          playAudioChunk(data.media.payload);
          break;

        case 'transcript':
          appendToTranscriptBuffer(data.speaker, data.text);
          break;

        case 'function_result':
          if (data.name === 'cast_vote' && data.result) {
            displayVoteResult(data.result);
          }
          break;

        case 'clear':
          // User interrupted - stop all audio playback
          stopAllAudio();
          flushTranscriptBuffer();
          break;
      }
    }

    // Audio playback
    let audioQueue = [];
    let isPlaying = false;
    let currentAudioSource = null;
    let audioSources = []; // Track all active sources to stop them

    function stopAllAudio() {
      // Stop all active audio sources
      audioSources.forEach(source => {
        try {
          if (source) {
            source.stop(0); // Stop immediately
          }
        } catch (e) {
          // Source may already be stopped or not started yet - this is expected
        }
      });
      audioSources = [];
      currentAudioSource = null;

      // Clear the queue
      audioQueue = [];
      isPlaying = false;

      console.log('ðŸ›‘ All audio stopped - ready for new response');
    }

    async function playAudioChunk(base64Audio) {
      const arrayBuffer = base64ToArrayBuffer(base64Audio);
      audioQueue.push(arrayBuffer);

      if (!isPlaying) {
        playNextChunk();
      }
    }

    async function playNextChunk() {
      if (audioQueue.length === 0) {
        isPlaying = false;
        currentAudioSource = null;
        return;
      }

      isPlaying = true;
      const chunk = audioQueue.shift();

      try {
        if (!audioContext || audioContext.state === 'closed') {
          audioContext = new AudioContext({ sampleRate: 8000 });
        }

        const int16Array = new Int16Array(chunk);
        const float32Array = new Float32Array(int16Array.length);

        for (let i = 0; i < int16Array.length; i++) {
          float32Array[i] = int16Array[i] / 32768;
        }

        const audioBuffer = audioContext.createBuffer(1, float32Array.length, 8000);
        audioBuffer.getChannelData(0).set(float32Array);

        const source = audioContext.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioContext.destination);

        // Track this source
        audioSources.push(source);
        currentAudioSource = source;

        source.onended = () => {
          // Remove from tracking
          const index = audioSources.indexOf(source);
          if (index > -1) {
            audioSources.splice(index, 1);
          }
          if (currentAudioSource === source) {
            currentAudioSource = null;
          }
          // Continue playing next chunk if not interrupted
          if (isPlaying && audioQueue.length > 0) {
            playNextChunk();
          } else {
            isPlaying = false;
          }
        };

        source.start();

      } catch (error) {
        console.error('Audio playback error:', error);
        // Continue with next chunk if available
        if (audioQueue.length > 0) {
          playNextChunk();
        } else {
          isPlaying = false;
        }
      }
    }

    // ==========================================================================
    // Transcript Buffering
    // ==========================================================================

    // Check if text is just an acknowledgment (not a real response)
    function isAcknowledgmentOnly(text) {
      if (!text) return false;

      const normalizedText = text.trim().toLowerCase();

      // List of acknowledgment phrases (exact matches or starts with)
      const acknowledgments = [
        'listening silently',
        'listening silently.',
        'sun rahi hun',
        'sun rahi hun.',
        'sun rahi hoon',
        'sun rahi hoon.',
        'sun raha hun',
        'sun raha hun.',
        'sun raha hoon',
        'sun raha hoon.',
        "i'm listening",
        "i'm listening.",
        'im listening',
        'im listening.',
        'listening',
        'listening.',
        // Handle variations with spaces
        'sun  r ahi hun',
        'sun  r ahi hun.',
        'sun  r ahi hoon',
        'sun  r ahi hoon.'
      ];

      // Check if text matches any acknowledgment exactly (with or without punctuation)
      for (const ack of acknowledgments) {
        const ackClean = ack.replace(/\.$/, ''); // Remove trailing period
        if (normalizedText === ack || normalizedText === ackClean || normalizedText.startsWith(ackClean)) {
          // Make sure it's not part of a longer sentence
          const remaining = normalizedText.substring(ackClean.length).trim();
          if (remaining === '' || remaining === '.' || remaining.startsWith('.')) {
            return true;
          }
        }
      }

      // Check if text is very short and contains acknowledgment keywords
      if (normalizedText.length < 25) {
        const ackKeywords = ['listening', 'sun', 'rahi', 'raha', 'hun', 'hoon'];
        const hasAckKeyword = ackKeywords.some(keyword => normalizedText.includes(keyword));
        if (hasAckKeyword && normalizedText.split(/\s+/).length <= 4) {
          return true;
        }
      }

      return false;
    }

    function appendToTranscriptBuffer(speaker, text) {
      const now = Date.now();

      if (transcriptBuffer.currentSpeaker && transcriptBuffer.currentSpeaker !== speaker) {
        flushTranscriptBuffer();
      }

      if (transcriptBuffer.flushTimeout) {
        clearTimeout(transcriptBuffer.flushTimeout);
      }

      if (!transcriptBuffer.currentSpeaker || transcriptBuffer.currentSpeaker !== speaker) {
        transcriptBuffer.currentSpeaker = speaker;
        transcriptBuffer.currentText = text;
        transcriptBuffer.currentElement = createTranscriptElement(speaker, text, true);
      } else {
        transcriptBuffer.currentText += ' ' + text;
        updateTranscriptElement(transcriptBuffer.currentElement, transcriptBuffer.currentText);
      }

      // Capture AI responses for character animation
      if (speaker === 'Sindh Police AI' || speaker === 'AI Board Member') {
        // Check if this is just an acknowledgment
        const fullText = transcriptBuffer.currentText || text;
        const isAck = isAcknowledgmentOnly(fullText);

        if (isAck) {
          // This is just an acknowledgment - keep in idle/listening state
          if (avatarContainer && avatarContainer.style.display !== 'none') {
            avatarContainer.classList.remove('speaking');
            startMouthAnimation('idle');

            // Show listening indicator
            const listeningIndicator = document.getElementById('listeningIndicator');
            if (listeningIndicator && heygenSessionActive) {
              listeningIndicator.classList.remove('hidden');
            }
          }
          // Don't send acknowledgments to HeyGen
        } else {
          // This is a real response - show speaking animation
          if (avatarContainer && avatarContainer.style.display !== 'none') {
            if (!avatarContainer.classList.contains('speaking')) {
              avatarContainer.classList.add('speaking');
              startMouthAnimation('speaking');

              // Hide listening indicator
              const listeningIndicator = document.getElementById('listeningIndicator');
              if (listeningIndicator) {
                listeningIndicator.classList.add('hidden');
              }
            }
          }

          // Buffer text for HeyGen if session is active (only for real responses)
          if (heygenSessionActive) {
            if (!aiResponseTextBuffer || transcriptBuffer.currentSpeaker !== speaker) {
              aiResponseTextBuffer = text;
            } else {
              aiResponseTextBuffer += ' ' + text;
            }
          }
        }
      }

      transcriptBuffer.lastUpdateTime = now;

      transcriptBuffer.flushTimeout = setTimeout(() => {
        flushTranscriptBuffer();
      }, TRANSCRIPT_FLUSH_DELAY);
    }

    function flushTranscriptBuffer() {
      if (transcriptBuffer.flushTimeout) {
        clearTimeout(transcriptBuffer.flushTimeout);
        transcriptBuffer.flushTimeout = null;
      }

      // Store transcript entry in backend before clearing
      if (transcriptBuffer.currentSpeaker && transcriptBuffer.currentText && currentMeetingId) {
        const fullText = transcriptBuffer.currentText.trim();
        storeTranscriptEntry(transcriptBuffer.currentSpeaker, fullText);

        // Handle Sindh Police AI responses
        if (transcriptBuffer.currentSpeaker === 'Sindh Police AI' || transcriptBuffer.currentSpeaker === 'AI Board Member') {
          const isAck = isAcknowledgmentOnly(fullText);

          if (!isAck) {
            // This is a real response - send to HeyGen and animate
            if (heygenSessionActive && aiResponseTextBuffer) {
              sendTextToHeyGenAvatar(aiResponseTextBuffer.trim());
              aiResponseTextBuffer = ''; // Clear buffer after sending
            } else {
              // Still show visual feedback even without HeyGen
              // Estimate speaking duration and animate
              const textLength = fullText.length;
              const estimatedDuration = Math.min((textLength / 4) * 1000, 10000);

              setTimeout(() => {
                // Only stop if we're not in the middle of another response
                if (transcriptBuffer.currentSpeaker !== 'Sindh Police AI' && transcriptBuffer.currentSpeaker !== 'AI Board Member') {
                  stopSpeakingAnimation();
                }
              }, estimatedDuration);
            }
          } else {
            // This is just an acknowledgment - don't animate, keep in listening state
            console.log('ðŸ”‡ Acknowledgment detected, keeping character in listening state');
            aiResponseTextBuffer = ''; // Clear buffer

            // Ensure character is in idle/listening state
            if (avatarContainer && avatarContainer.style.display !== 'none') {
              avatarContainer.classList.remove('speaking');
              startMouthAnimation('idle');

              // Show listening indicator
              const listeningIndicator = document.getElementById('listeningIndicator');
              if (listeningIndicator && heygenSessionActive) {
                listeningIndicator.classList.remove('hidden');
              }

              // Update status text
              if (avatarStatusText) {
                avatarStatusText.textContent = 'Ready to participate';
                avatarStatusText.className = 'text-xs sm:text-sm text-black/60';
              }
            }
          }
        } else {
          // User is speaking - show listening state
          if (avatarContainer && avatarContainer.style.display !== 'none' && heygenSessionActive) {
            const listeningIndicator = document.getElementById('listeningIndicator');
            if (listeningIndicator) {
              listeningIndicator.classList.remove('hidden');
            }
            avatarContainer.classList.remove('speaking');
            startMouthAnimation('idle');
          }
        }
      }

      if (transcriptBuffer.currentElement) {
        const textSpan = transcriptBuffer.currentElement.querySelector('.message-text');
        if (textSpan) {
          textSpan.classList.remove('typing-indicator');
        }
      }

      transcriptBuffer.currentSpeaker = null;
      transcriptBuffer.currentText = '';
      transcriptBuffer.currentElement = null;
      transcriptBuffer.lastUpdateTime = null;
    }

    async function storeTranscriptEntry(speaker, text) {
      if (!currentMeetingId || !authToken) return;

      try {
        await fetch('/api/transcript/store', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            meeting_id: currentMeetingId,
            speaker: speaker,
            text: text
          })
        });
      } catch (error) {
        console.error('Failed to store transcript entry:', error);
      }
    }

    function createTranscriptElement(speaker, text, isTyping = false) {
      const placeholder = transcriptArea.querySelector('.text-center');
      if (placeholder) {
        placeholder.remove();
      }

      const entry = document.createElement('div');
      entry.className = 'mb-4 animate-fade-in';

      const time = new Date().toLocaleTimeString();
      let speakerClass = 'text-gray-400';
      let bgClass = 'bg-white/30';
      let borderClass = 'border-gray-300/10';

      if (speaker === 'Sindh Police AI' || speaker === 'AI Board Member') {
        speakerClass = 'text-navy-600';
        bgClass = 'bg-blue-50/80';
        borderClass = 'border-blue-200/50';
      } else if (speaker === 'Secretary' || speaker === 'User') {
        speakerClass = 'text-gray-700';
        bgClass = 'bg-gray-50/80';
        borderClass = 'border-gold-500/20';
      }

      entry.innerHTML = `
          <div class="${bgClass} rounded-lg p-2.5 sm:p-3 border ${borderClass}">
            <div class="flex items-center gap-2 mb-1 flex-wrap">
              <span class="${speakerClass} font-semibold text-xs sm:text-sm truncate">${speaker}</span>
              <span class="text-[10px] sm:text-xs text-gray-500 whitespace-nowrap flex-shrink-0">${time}</span>
            </div>
            <p class="message-text text-gray-800 text-xs sm:text-sm leading-relaxed break-words ${isTyping ? 'typing-indicator' : ''}">${text}</p>
          </div>
        `;

      transcriptArea.appendChild(entry);
      transcriptArea.scrollTop = transcriptArea.scrollHeight;

      return entry;
    }

    function updateTranscriptElement(element, text) {
      if (element) {
        const textSpan = element.querySelector('.message-text');
        if (textSpan) {
          textSpan.textContent = text;
        }
        transcriptArea.scrollTop = transcriptArea.scrollHeight;
      }
    }

    function addCompleteTranscriptEntry(speaker, text) {
      createTranscriptElement(speaker, text, false);
    }

    function addSystemMessage(text) {
      const entry = document.createElement('div');
      entry.className = 'mb-2 sm:mb-3 text-center';
      entry.innerHTML = `
          <span class="inline-block text-[10px] sm:text-xs text-black/50 bg-gray-200/10 px-2 sm:px-3 py-1 rounded-full border border-gray-300/20 break-words max-w-full">
            ${text}
          </span>
        `;
      transcriptArea.appendChild(entry);
      transcriptArea.scrollTop = transcriptArea.scrollHeight;
    }

    // ==========================================================================
    // UI Helpers
    // ==========================================================================

    function updateAIStatus(status) {
      aiStatus.className = 'status-indicator';

      switch (status) {
        case 'online':
          aiStatus.classList.add('status-online');
          aiStatusText.textContent = 'AI Online';
          break;
        case 'unstable':
          aiStatus.classList.add('status-unstable');
          aiStatusText.textContent = 'Connection Unstable';
          break;
        case 'ready':
          aiStatus.classList.add('status-online');
          aiStatusText.textContent = 'AI Ready';
          break;
        default:
          aiStatus.classList.add('status-offline');
          aiStatusText.textContent = 'AI Offline';
      }
    }

    function showConnectionAlert(type, message) {
      const alertContent = document.getElementById('alertContent');
      const alertIcon = document.getElementById('alertIcon');
      const alertMessage = document.getElementById('alertMessage');

      let bgClass, borderClass, iconHtml;

      switch (type) {
        case 'success':
          bgClass = 'bg-green-500/20';
          borderClass = 'border-green-500';
          iconHtml = '<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
          break;
        case 'error':
          bgClass = 'bg-red-500/20';
          borderClass = 'border-red-500';
          iconHtml = '<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
          break;
        case 'warning':
          bgClass = 'bg-yellow-500/20';
          borderClass = 'border-yellow-500';
          iconHtml = '<svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
          break;
        default:
          bgClass = 'bg-gray-200/20';
          borderClass = 'border-gray-300';
          iconHtml = '<svg class="w-5 h-5 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
      }

      alertContent.className = `glass-card px-6 py-3 rounded-full flex items-center gap-3 ${borderClass} ${bgClass}`;
      alertIcon.innerHTML = iconHtml;
      alertMessage.textContent = message;

      connectionAlert.classList.remove('hidden');

      setTimeout(() => {
        connectionAlert.classList.add('hidden');
      }, 4000);
    }

    function startAudioVisualization() {
      const bars = audioVisualizer.querySelectorAll('div');

      function animate() {
        if (!isRecording) return;

        bars.forEach(bar => {
          const height = Math.random() * 80 + 20;
          bar.style.height = `${height}%`;
        });

        requestAnimationFrame(animate);
      }

      animate();
    }

    function stopAudioVisualization() {
      const bars = audioVisualizer.querySelectorAll('div');
      bars.forEach(bar => {
        bar.style.height = '30%';
      });
    }

    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    // ==========================================================================
    // HeyGen Avatar Integration
    // ==========================================================================

    async function startHeyGenAvatar() {
      if (!currentMeetingId || !authToken) {
        console.warn('âš ï¸ Cannot start AI character: missing meeting ID or token');
        return;
      }

      try {
        console.log('ðŸŽ¬ Starting AI character...');

        // Show avatar container immediately with animation
        avatarContainer.style.display = 'block';
        avatarContainer.classList.remove('hidden');
        avatarContainer.style.animation = 'fadeIn 0.5s ease-out';
        avatarStatus.textContent = 'Connecting...';
        avatarStatus.className = 'text-[10px] sm:text-xs px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 whitespace-nowrap';

        // Show listening indicator
        const listeningIndicator = document.getElementById('listeningIndicator');
        if (listeningIndicator) {
          listeningIndicator.classList.remove('hidden');
        }

        // Start mouth animation (idle state)
        startMouthAnimation('idle');

        // Add blinking animation to eyes
        const leftEye = document.getElementById('leftEye');
        const rightEye = document.getElementById('rightEye');
        if (leftEye && rightEye) {
          leftEye.style.animation = 'eyeBlink 3s ease-in-out infinite';
          rightEye.style.animation = 'eyeBlink 3s ease-in-out infinite';
          rightEye.style.animationDelay = '0.1s';
        }

        console.log('âœ… AI character container shown');

        // Start HeyGen session via backend
        const response = await fetch('/api/heygen/session/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            meeting_id: currentMeetingId
          })
        });

        const data = await response.json();
        console.log('ðŸ“¡ HeyGen session response:', data);

        if (!response.ok || !data.success) {
          throw new Error(data.detail || 'Failed to start HeyGen session');
        }

        heygenSessionId = data.session_id;
        heygenSessionActive = true;
        console.log('âœ… HeyGen session active:', heygenSessionId);

        // Connect to HeyGen video stream using LiveKit
        // HeyGen uses LiveKit for video streaming (per their docs)
        const LiveKit = window.LiveKitClient || window.LiveKit;
        if (data.livekit_url && data.livekit_token && LiveKit) {
          console.log('ðŸ“¦ Connecting to HeyGen via LiveKit...');
          try {
            const { Room, RoomEvent, RemoteTrackPublication, Track } = LiveKit;

            // Create LiveKit room connection
            const room = new Room({
              adaptiveStream: true,
              dynacast: true,
            });

            // Connect to LiveKit room
            await room.connect(data.livekit_url, data.livekit_token);
            console.log('âœ… Connected to LiveKit room');

            // Set up video element
            const videoElement = avatarVideo;
            videoElement.style.display = 'block';
            avatarPlaceholder.style.display = 'none';

            // Listen for remote tracks (video stream from HeyGen)
            room.on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
              console.log('ðŸ“¹ Video track subscribed:', track.kind);

              if (track.kind === 'video') {
                // Attach video track to video element
                const videoElement = avatarVideo;
                track.attach(videoElement);
                videoElement.play().catch(e => console.error('Video play error:', e));

                avatarStatus.textContent = 'Connected';
                avatarStatus.className = 'text-[10px] sm:text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30 whitespace-nowrap';
                if (avatarStatusText) {
                  avatarStatusText.textContent = 'Ready to participate';
                }

                console.log('âœ… HeyGen video stream connected');
              }
            });

            // Store room for cleanup
            heygenAvatar = { room: room, type: 'livekit' };
            heygenSessionId = data.session_id;

          } catch (livekitError) {
            console.warn('âš ï¸ LiveKit connection error, using visual mode:', livekitError);
            // Fallback to visual mode
            avatarStatus.textContent = 'Ready';
            avatarStatus.className = 'text-[10px] sm:text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30 whitespace-nowrap';
            avatarPlaceholder.style.display = 'flex';
            avatarVideo.style.display = 'none';
            if (avatarStatusText) {
              avatarStatusText.textContent = 'Ready to participate';
            }
            if (listeningIndicator) {
              listeningIndicator.classList.remove('hidden');
            }
          }
        } else {
          // Fallback: Visual character mode (no LiveKit credentials or SDK)
          console.log('ðŸ’¡ Using visual character mode (LiveKit not available)');
          if (!data.livekit_url) {
            console.log('ðŸ’¡ No LiveKit URL in response - backend API may need different endpoint');
            console.log('ðŸ’¡ Response data:', JSON.stringify(data, null, 2));
          }
          const LiveKit = window.LiveKitClient || window.LiveKit;
          if (!LiveKit) {
            console.log('ðŸ’¡ LiveKit SDK not loaded - check browser console');
          }

          avatarStatus.textContent = 'Ready';
          avatarStatus.className = 'text-[10px] sm:text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/30 whitespace-nowrap';
          avatarPlaceholder.style.display = 'flex';
          avatarVideo.style.display = 'none';
          if (avatarStatusText) {
            avatarStatusText.textContent = 'Ready to participate';
          }
          if (listeningIndicator) {
            listeningIndicator.classList.remove('hidden');
          }
        }

      } catch (error) {
        console.error('âŒ AI character start error:', error);
        // Still show the character even if there's an error
        avatarContainer.style.display = 'block';
        avatarContainer.classList.remove('hidden');
        avatarStatus.textContent = 'Visual Mode';
        avatarStatus.className = 'text-[10px] sm:text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30 whitespace-nowrap';
        avatarPlaceholder.style.display = 'flex';
        avatarVideo.style.display = 'none';
        if (avatarStatusText) {
          avatarStatusText.textContent = 'Character active';
        }
        if (listeningIndicator) {
          listeningIndicator.classList.remove('hidden');
        }
        // Don't show error alert - character will still work visually
      }
    }

    async function stopHeyGenAvatar() {
      if (!heygenSessionActive || !heygenSessionId) {
        return;
      }

      try {
        // Stop HeyGen session via backend
        if (currentMeetingId && authToken) {
          await fetch('/api/heygen/session/stop', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify({
              meeting_id: currentMeetingId
            })
          });
        }

        // Stop LiveKit connection if active
        if (heygenAvatar) {
          try {
            if (heygenAvatar.type === 'livekit' && heygenAvatar.room) {
              await heygenAvatar.room.disconnect();
              console.log('âœ… LiveKit room disconnected');
            } else if (heygenAvatar.stopAvatar) {
              await heygenAvatar.stopAvatar({ sessionId: heygenSessionId });
            } else if (heygenAvatar.stop) {
              await heygenAvatar.stop();
            }
          } catch (e) {
            console.warn('âš ï¸ Error stopping HeyGen connection:', e);
          }
          heygenAvatar = null;
        }

        // Hide avatar container
        avatarContainer.style.display = 'none';
        avatarContainer.classList.add('hidden');
        avatarVideo.style.display = 'none';
        avatarPlaceholder.style.display = 'flex';
        avatarStatus.textContent = 'Disconnected';

        heygenSessionId = null;
        heygenSessionActive = false;
        aiResponseTextBuffer = '';

        console.log('âœ… HeyGen avatar stopped');

      } catch (error) {
        console.error('âŒ HeyGen avatar stop error:', error);
      }
    }

    async function sendTextToHeyGenAvatar(text) {
      if (!heygenSessionActive || !text || !text.trim()) {
        return;
      }

      // Show speaking indicators and animations
      if (speakingIndicator) {
        speakingIndicator.classList.remove('hidden');
      }
      const speakingRings = document.getElementById('speakingRings');
      if (speakingRings) {
        speakingRings.classList.remove('hidden');
      }
      if (avatarStatusText) {
        avatarStatusText.textContent = 'Speaking...';
        avatarStatusText.className = 'text-xs sm:text-sm text-green-400 animate-pulse';
      }

      // Add speaking class to container for glow effect
      avatarContainer.classList.add('speaking');

      // Hide listening indicator when speaking
      const listeningIndicator = document.getElementById('listeningIndicator');
      if (listeningIndicator) {
        listeningIndicator.classList.add('hidden');
      }

      // Start mouth animation for speaking
      startMouthAnimation('speaking');

      try {
        // For LiveKit connection, use backend API to send text
        // HeyGen handles text-to-speech via their API
        if (heygenAvatar && heygenAvatar.type === 'livekit') {
          // LiveKit connection is for video only
          // Text-to-speech is handled via HeyGen API
          console.log('ðŸ“¢ Sending text via HeyGen API for LiveKit session');
        }

        // Fallback: Use backend API to send text to HeyGen
        const response = await fetch('/api/heygen/avatar/speak', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({
            meeting_id: currentMeetingId,
            session_id: heygenSessionId,
            text: text.trim()
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          console.log('âœ… AI character speaking (API):', text.substring(0, 50) + '...');
          if (data.note) {
            console.log('ðŸ’¡', data.note);
          }
          // Hide indicator after a delay (estimate speaking time)
          const estimatedDuration = Math.min((text.length / 4) * 1000, 15000);
          setTimeout(() => {
            stopSpeakingAnimation();
          }, estimatedDuration);
        } else {
          console.warn('âš ï¸ Speak API error:', data.detail || 'Unknown error');
          // Still show visual feedback even if API fails
          const estimatedDuration = Math.min((text.length / 4) * 1000, 10000);
          setTimeout(() => {
            stopSpeakingAnimation();
          }, estimatedDuration);
        }

      } catch (error) {
        console.error('âŒ Error sending text to AI character:', error);
        // Reset to listening state on error
        stopSpeakingAnimation();
      }
    }

    // Animation functions for character
    function startMouthAnimation(state) {
      const mouth = document.getElementById('avatarMouth');
      if (!mouth) return;

      if (state === 'speaking') {
        // Animate mouth for speaking
        mouth.style.animation = 'mouthSpeak 0.3s ease-in-out infinite';
      } else if (state === 'idle') {
        // Subtle idle animation
        mouth.style.animation = 'mouthIdle 2s ease-in-out infinite';
      } else {
        mouth.style.animation = 'none';
      }
    }

    function stopSpeakingAnimation() {
      if (speakingIndicator) {
        speakingIndicator.classList.add('hidden');
      }
      const speakingRings = document.getElementById('speakingRings');
      if (speakingRings) {
        speakingRings.classList.add('hidden');
      }
      if (avatarStatusText) {
        avatarStatusText.textContent = 'Ready to participate';
        avatarStatusText.className = 'text-xs sm:text-sm text-black/60';
      }

      // Remove speaking class from container
      avatarContainer.classList.remove('speaking');

      // Show listening indicator again
      const listeningIndicator = document.getElementById('listeningIndicator');
      if (listeningIndicator && heygenSessionActive) {
        listeningIndicator.classList.remove('hidden');
      }

      // Return mouth to idle state
      startMouthAnimation('idle');
    }

    // Initialize
    checkSession();
  </script>
</body>

</html>